document.addEventListener("DOMContentLoaded", () => {
    const e = document.getElementById("searchInput"),
        t = document.getElementById("categoryFilter"),
        n = document.getElementById("toolsList"),
        o = document.getElementById("pagination"),
        i = document.getElementById("bookmarksList"),
        a = document.getElementById("languageSelect"),
        r = document.getElementById("toolName"),
        s = document.getElementById("toolDesc"),
        l = document.getElementById("toolCategory"),
        c = document.getElementById("toolUrl"),
        d = document.getElementById("toolFree"),
        m = document.getElementById("captchaInput"),
        u = document.getElementById("captchaText"),
        p = document.getElementById("refreshCaptcha"),
        f = document.getElementById("submitToolBtn"),
        g = document.getElementById("submitStatus"),
        h = document.getElementById("reviewTool"),
        v = document.getElementById("reviewText"),
        b = document.getElementById("reviewRating"),
        y = document.getElementById("submitReviewBtn"),
        w = document.getElementById("reviewsList"),
        k = document.getElementById("generateImagesBtn"),
        x = document.getElementById("freeToolsBtn"),
        L = document.getElementById("latestBtn"),
        S = document.getElementById("forYouBtn"),
        C = document.getElementById("trendingBtn"),
        statsText = document.getElementById("statsText");

    let T = [], P = 1, A = 9, D = localStorage.getItem("reviews") ? JSON.parse(localStorage.getItem("reviews")) : [], I = localStorage.getItem("submittedTools") ? JSON.parse(localStorage.getItem("submittedTools")) : [];

    // Fungsi animasi counter
    function animateCounter(target, element, initialDuration, interval) {
        let current = 0;
        let isInitial = true;
        const range = target - current;
        const increment = target / (initialDuration / 16);
        const startTime = performance.now();

        function update() {
            const currentTime = performance.now();
            if (isInitial) {
                const progress = Math.min((currentTime - startTime) / initialDuration, 1);
                current = Math.floor(current + range * easeInOutQuad(progress));
                if (progress >= 1) {
                    current = target;
                    isInitial = false;
                    setTimeout(startRandomCounter, interval * 1000);
                }
            } else {
                current += Math.floor(Math.random() * 10) + 1;
            }
            const tasks = Math.floor(current * 0.354).toLocaleString();
            const jobs = Math.floor(current * 0.13).toLocaleString();
            element.textContent = current.toLocaleString() + " AI tools for " + tasks + " tasks and " + jobs + " jobs";
            if (isInitial || !isInitial) requestAnimationFrame(update);
        }

        function easeInOutQuad(t) {
            return t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2;
        }

        function startRandomCounter() {
            setInterval(() => {
                current += Math.floor(Math.random() * 10) + 1;
                const tasks = Math.floor(current * 0.354).toLocaleString();
                const jobs = Math.floor(current * 0.13).toLocaleString();
                element.textContent = current.toLocaleString() + " AI tools for " + tasks + " tasks and " + jobs + " jobs";
            }, interval * 1000);
        }

        requestAnimationFrame(update);
    }

    if (statsText) {
        animateCounter(38345, statsText, 2000, 2);
    }

    fetch("tools.json").then(e => {
        if (!e.ok) throw new Error("Gagal memuat tools.json");
        return e.json();
    }).then(e => {
        T = [...e, ...I];
        const t = new Set(T.map(e => e.category));
        t.forEach(e => {
            const n = document.createElement("option");
            n.value = e, n.textContent = e, t.appendChild(n);
        }), fetch("languages.json").then(e => e.json()).then(e => {
            a.addEventListener("change", t => {
                const n = e[t.target.value];
                document.getElementById("heroText").textContent = n.hero,
                    document.getElementById("taglineText").textContent = n.tagline,
                    document.getElementById("statsText").textContent = n.stats,
                    document.getElementById("rankText").textContent = n.rank,
                    document.getElementById("spotlightText").textContent = n.spotlight,
                    document.getElementById("featuredBtnText").textContent = n.featuredBtn,
                    document.getElementById("releasedText").textContent = n.released,
                    document.getElementById("bookmarksTitle").textContent = n.bookmarks,
                    document.getElementById("submitToolTitle").textContent = n.submitTool,
                    document.getElementById("reviewsTitle").textContent = n.reviews,
                    document.getElementById("tutorialLink").textContent = n.tutorial,
                    document.getElementById("modeText").textContent = n.mode;
                if (statsText) {
                    animateCounter(38345, statsText, 2000, 2);
                }
            }), a.dispatchEvent(new Event("change"));
        }), M();
    }).catch(e => {
        n.innerHTML = '<p class="error">Error: Gagal memuat data alat AI.</p>', console.error(e);
    });

    function M() {
        n.innerHTML = "", i.innerHTML = "";
        let t = E(),
            o = T.filter(e => !t.value || e.category === t.value).filter(e => e.name.toLowerCase().includes(E().toLowerCase()) || e.description.toLowerCase().includes(E().toLowerCase()) || e.tags.some(t => t.toLowerCase().includes(E().toLowerCase())));
        o.slice((P - 1) * A, P * A).forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card");
            const o = localStorage.getItem("bookmarks")?.split(",").includes(e.id);
            t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a><span class="tool-check ${o ? "tool-bookmark" : ""}" data-id="${e.id}">${o ? "‚≠ê" : "‚úÖ"}</span>`,
                e.tags.forEach(e => {
                    const n = document.createElement("span");
                    n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
                }), t.querySelector(".tool-check").addEventListener("click", () => {
                    !o && N(e.id);
                }), n.appendChild(t);
        });
        const a = localStorage.getItem("bookmarks")?.split(",").filter(e => e).map(e => T.find(t => t.id === e));
        a.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a><span class="tool-check tool-bookmark">‚≠ê</span>`,
                e.tags.forEach(e => {
                    const n = document.createElement("span");
                    n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
                }), i.appendChild(t);
        }), o.innerHTML = "", Array.from({ length: Math.ceil(T.length / A) }, (e, t) => t + 1).forEach(e => {
            const t = document.createElement("button");
            t.textContent = e, t.addEventListener("click", () => {
                P = e, M(), t.classList.add("active"), Array.from(o.children).forEach(n => n !== t && n.classList.remove("active"));
            }), e === P && t.classList.add("active"), o.appendChild(t);
        }), w.innerHTML = "", D.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("review-card"), t.innerHTML = `<p><strong>${e.tool}</strong> - ${e.review} (${e.rating}/5)</p>`, w.appendChild(t);
        }), Notification.requestPermission().then(e => {
            "granted" === e && new Notification("New Tool Added!", { body: "Check out the latest AI tools on ToolVerse Nesia AI." });
        });
    }

    function E() {
        return e.value || "";
    }

    e.addEventListener("input", M), t.addEventListener("change", M), p.addEventListener("click", () => {
        u.textContent = Math.random().toString(36).substring(2, 8).toUpperCase();
    }), f.addEventListener("click", () => {
        const e = u.textContent;
        if (m.value === e && r.value && s.value && l.value && c.value) {
            const e = {
                id: `sub_${Date.now()}`,
                name: r.value,
                description: s.value,
                category: l.value,
                url: c.value,
                logo: "logo.png",
                tags: [l.value],
                date_added: new Date().toISOString().split("T")[0],
                popularity: 4.0,
                free: d.checked
            };
            I.push(e), localStorage.setItem("submittedTools", JSON.stringify(I)), T = [...T, e], g.textContent = "Tool submitted successfully!", setTimeout(() => { g.textContent = "" }, 3000), r.value = "", s.value = "", l.value = "", c.value = "", m.value = "", d.checked = false;
        } else g.textContent = "CAPTCHA or fields incorrect!";
    }), y.addEventListener("click", () => {
        h.value && v.value && b.value && (D.push({ tool: h.value, review: v.value, rating: b.value }), localStorage.setItem("reviews", JSON.stringify(D)), h.value = "", v.value = "", b.value = "", M());
    });

    const N = e => {
        let t = localStorage.getItem("bookmarks")?.split(",") ?? [];
        t.includes(e) ? t = t.filter(t => t !== e) : (t.push(e), t = t.filter(e => e)), localStorage.setItem("bookmarks", t), M();
    };

    u.textContent = Math.random().toString(36).substring(2, 8).toUpperCase();

    k.addEventListener("click", () => {
        const e = T.filter(e => e.category === "Image");
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    x.addEventListener("click", () => {
        const e = T.filter(e => e.free);
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    L.addEventListener("click", () => {
        const e = T.sort((e, t) => new Date(t.date_added) - new Date(e.date_added)).slice(0, 1);
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    S.addEventListener("click", () => {
        const e = T.filter(e => e.category === "Personal");
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    C.addEventListener("click", () => {
        const e = T.filter(e => e.name.toLowerCase().includes("trending"));
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"‚òÖ".repeat(Math.floor(e.popularity)).padEnd(5, "‚òÜ")}</div><a href="${e.url}" target="_blank" class="tool-link">üåê</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    // Tombol Menu
    document.querySelector('.menu').addEventListener('click', () => {
        const menu = document.createElement('div');
        menu.innerHTML = '<a href="index.html">Home</a><a href="about.html">About</a><a href="blog.html">Blog</a><a href="contact.html">Contact</a><a href="faq.html">FAQ</a><a href="tutorial.html">Tutorial</a><a href="forum.html">Forum</a>';
        menu.classList.add('dropdown-menu');
        document.body.appendChild(menu);
        setTimeout(() => menu.remove(), 5000);
    });

    // Tombol Actions
    document.querySelector('.actions').addEventListener('click', () => {
        alert('Pengaturan: Mode Gelap/Terang (Belum Aktif)');
    });

    // Tombol Spotlight
    document.querySelector('.spotlight-btn').addEventListener('click', () => {
        const spotlightTools = T.sort((a, b) => b.popularity - a.popularity).slice(0, 3);
        alert('Spotlight Tools: ' + spotlightTools.map(t => t.name).join(', '));
    });

    // Tombol Footer
    document.querySelectorAll('.footer-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
            const social = btn.getAttribute('data-social');
            if (social === 'whatsapp') window.location.href = 'https://wa.me/62895354511777';
            if (social === 'chat') window.location.href = 'forum.html';
            if (social === 'website') window.location.href = 'https://x.ai';
        });
    });

    // Form Kontak
    document.getElementById('contactForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('contactName').value;
        const email = document.getElementById('contactEmail').value;
        const message = document.getElementById('contactMessage').value;
        const contacts = JSON.parse(localStorage.getItem('contacts') || '[]');
        contacts.push({ name, email, message, date: new Date().toISOString() });
        localStorage.setItem('contacts', JSON.stringify(contacts));
        alert('Pesan berhasil dikirim!');
        e.target.reset();
    });

    // Forum Interaktif
    document.getElementById('forumSubmit')?.addEventListener('click', () => {
        const post = document.getElementById('forumPost').value;
        if (post) {
            const posts = JSON.parse(localStorage.getItem('forumPosts') || '[]');
            posts.push({ text: post, date: new Date().toISOString(), user: 'Anonymous' });
            localStorage.setItem('forumPosts', JSON.stringify(posts));
            document.getElementById('forumPost').value = '';
            renderForumPosts();
        }
    });

    function renderForumPosts() {
        const posts = JSON.parse(localStorage.getItem('forumPosts') || '[]');
        const forumPosts = document.getElementById('forumPosts');
        forumPosts.innerHTML = posts.map(p => `<p>${p.text} <span>${p.date}</span></p>`).join('');
    }
    renderForumPosts();

    // FAQ Interaktive
    const faqs = [
        { question: "Bagaimana cara menggunakan alat ini?", answer: "Pilih alat dari daftar dan klik untuk detail." },
        { question: "Apa yang gratis?", answer: "Cek tab Free Tools untuk alat gratis." }
    ];
    document.getElementById('faqList')?.addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            e.target.nextElementSibling.classList.toggle('show');
        }
    });
    const faqList = document.getElementById('faqList');
    faqList.innerHTML = faqs.map(faq => `
        <div><button>${faq.question}</button><p class="faq-answer">${faq.answer}</p></div>
    `).join('');
});
