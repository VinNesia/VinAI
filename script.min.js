document.addEventListener("DOMContentLoaded", () => {
    const e = document.getElementById("searchInput"),
        t = document.getElementById("categoryFilter"),
        n = document.getElementById("toolsList"),
        o = document.getElementById("pagination"),
        i = document.getElementById("bookmarksList"),
        a = document.getElementById("languageSelect"),
        r = document.getElementById("toolName"),
        s = document.getElementById("toolDesc"),
        l = document.getElementById("toolCategory"),
        c = document.getElementById("toolUrl"),
        d = document.getElementById("toolFree"),
        m = document.getElementById("captchaInput"),
        u = document.getElementById("captchaText"),
        p = document.getElementById("refreshCaptcha"),
        f = document.getElementById("submitToolBtn"),
        g = document.getElementById("submitStatus"),
        h = document.getElementById("reviewTool"),
        v = document.getElementById("reviewText"),
        b = document.getElementById("reviewRating"),
        y = document.getElementById("submitReviewBtn"),
        w = document.getElementById("reviewsList"),
        k = document.getElementById("generateImagesBtn"),
        x = document.getElementById("freeToolsBtn"),
        L = document.getElementById("latestBtn"),
        S = document.getElementById("forYouBtn"),
        C = document.getElementById("trendingBtn");

    let T = [], P = 1, A = 9, D = localStorage.getItem("reviews") ? JSON.parse(localStorage.getItem("reviews")) : [], I = localStorage.getItem("submittedTools") ? JSON.parse(localStorage.getItem("submittedTools")) : [];

    fetch("tools.json").then(e => {
        if (!e.ok) throw new Error("Gagal memuat tools.json");
        return e.json();
    }).then(e => {
        T = [...e, ...I];
        const t = new Set(T.map(e => e.category));
        t.forEach(e => {
            const n = document.createElement("option");
            n.value = e, n.textContent = e, t.appendChild(n);
        }), fetch("languages.json").then(e => e.json()).then(e => {
            a.addEventListener("change", t => {
                const n = e[t.target.value];
                document.getElementById("heroText").textContent = n.hero,
                    document.getElementById("taglineText").textContent = n.tagline,
                    document.getElementById("statsText").textContent = n.stats,
                    document.getElementById("rankText").textContent = n.rank,
                    document.getElementById("spotlightText").textContent = n.spotlight,
                    document.getElementById("featuredBtnText").textContent = n.featuredBtn,
                    document.getElementById("releasedText").textContent = n.released,
                    document.getElementById("bookmarksTitle").textContent = n.bookmarks,
                    document.getElementById("submitToolTitle").textContent = n.submitTool,
                    document.getElementById("reviewsTitle").textContent = n.reviews,
                    document.getElementById("tutorialLink").textContent = n.tutorial,
                    document.getElementById("modeText").textContent = n.mode;
            }), a.dispatchEvent(new Event("change"));
        }), M();
    }).catch(e => {
        n.innerHTML = '<p class="error">Error: Gagal memuat data alat AI.</p>', console.error(e);
    });

    function M() {
        n.innerHTML = "", i.innerHTML = "";
        let t = E(),
            o = T.filter(e => !t.value || e.category === t.value).filter(e => e.name.toLowerCase().includes(E().toLowerCase()) || e.description.toLowerCase().includes(E().toLowerCase()) || e.tags.some(t => t.toLowerCase().includes(E().toLowerCase())));
        o.slice((P - 1) * A, P * A).forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card");
            const o = localStorage.getItem("bookmarks")?.split(",").includes(e.id);
            t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a><span class="tool-check ${o ? "tool-bookmark" : ""}" data-id="${e.id}">${o ? "⭐" : "✅"}</span>`,
                e.tags.forEach(e => {
                    const n = document.createElement("span");
                    n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
                }), t.querySelector(".tool-check").addEventListener("click", () => {
                    !o && N(e.id);
                }), n.appendChild(t);
        });
        const a = localStorage.getItem("bookmarks")?.split(",").filter(e => e).map(e => T.find(t => t.id === e));
        a.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a><span class="tool-check tool-bookmark">⭐</span>`,
                e.tags.forEach(e => {
                    const n = document.createElement("span");
                    n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
                }), i.appendChild(t);
        }), o.innerHTML = "", Array.from({ length: Math.ceil(T.length / A) }, (e, t) => t + 1).forEach(e => {
            const t = document.createElement("button");
            t.textContent = e, t.addEventListener("click", () => {
                P = e, M(), t.classList.add("active"), Array.from(o.children).forEach(n => n !== t && n.classList.remove("active"));
            }), e === P && t.classList.add("active"), o.appendChild(t);
        }), w.innerHTML = "", D.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("review-card"), t.innerHTML = `<p><strong>${e.tool}</strong> - ${e.review} (${e.rating}/5)</p>`, w.appendChild(t);
        }), Notification.requestPermission().then(e => {
            "granted" === e && new Notification("New Tool Added!", { body: "Check out the latest AI tools on ToolVerse Nesia AI." });
        });
    }

    function E() {
        return e.value || "";
    }

    e.addEventListener("input", M), t.addEventListener("change", M), p.addEventListener("click", () => {
        u.textContent = Math.random().toString(36).substring(2, 8).toUpperCase();
    }), f.addEventListener("click", () => {
        const e = u.textContent;
        if (m.value === e && r.value && s.value && l.value && c.value) {
            const e = {
                id: `sub_${Date.now()}`,
                name: r.value,
                description: s.value,
                category: l.value,
                url: c.value,
                logo: "logo.png",
                tags: [l.value],
                date_added: new Date().toISOString().split("T")[0],
                popularity: 4.0,
                free: d.checked
            };
            I.push(e), localStorage.setItem("submittedTools", JSON.stringify(I)), T = [...T, e], g.textContent = "Tool submitted successfully!", setTimeout(() => { g.textContent = "" }, 3000), r.value = "", s.value = "", l.value = "", c.value = "", m.value = "", d.checked = false;
        } else g.textContent = "CAPTCHA or fields incorrect!";
    }), y.addEventListener("click", () => {
        h.value && v.value && b.value && (D.push({ tool: h.value, review: v.value, rating: b.value }), localStorage.setItem("reviews", JSON.stringify(D)), h.value = "", v.value = "", b.value = "", M());
    });

    const N = e => {
        let t = localStorage.getItem("bookmarks")?.split(",") ?? [];
        t.includes(e) ? t = t.filter(t => t !== e) : (t.push(e), t = t.filter(e => e)), localStorage.setItem("bookmarks", t), M();
    };

    u.textContent = Math.random().toString(36).substring(2, 8).toUpperCase();

    k.addEventListener("click", () => {
        const e = T.filter(e => e.category === "Image");
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    x.addEventListener("click", () => {
        const e = T.filter(e => e.free);
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    L.addEventListener("click", () => {
        const e = T.sort((e, t) => new Date(t.date_added) - new Date(e.date_added)).slice(0, 1);
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    S.addEventListener("click", () => {
        const e = T.filter(e => e.category === "Personal");
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });

    C.addEventListener("click", () => {
        const e = T.filter(e => e.name.toLowerCase().includes("trending"));
        n.innerHTML = "", e.forEach(e => {
            const t = document.createElement("div");
            t.classList.add("tool-card"), t.innerHTML = `<img src="${e.logo}" alt="${e.name} Icon" class="tool-thumbnail"><span class="tool-name">${e.name}</span><span class="tool-category">${e.category}</span><span class="tool-date">${e.date_added}</span><div class="rating">${"★".repeat(Math.floor(e.popularity)).padEnd(5, "☆")}</div><a href="${e.url}" target="_blank" class="tool-link">🌐</a>`, e.tags.forEach(e => {
                const n = document.createElement("span");
                n.classList.add("tool-tag"), n.textContent = e, t.appendChild(n);
            }), n.appendChild(t);
        }), P = 1, M();
    });
});
